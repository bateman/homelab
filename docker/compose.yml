# =============================================================================
# Docker Compose - Infrastructure Stack
# NAS QNAP TS-435XeU - Homelab
#
# Infrastructure services: DNS, SSO, container management, backup
# For media stack, see compose.media.yml
# For home automation (optional), see compose.homeassistant.yml
#
# Usage:
#   docker compose -f compose.yml -f compose.media.yml up -d
#   or simply: make up
#
# To include Home Assistant (adds ~2GB RAM):
#   docker compose -f compose.yml -f compose.media.yml -f compose.homeassistant.yml up -d
# =============================================================================

# Shared networks for all services
# Network names are explicitly set to ensure consistency across compose files
networks:
  media_net:
    name: homelab_media_net
    driver: bridge
  proxy:
    name: homelab_proxy
    driver: bridge
  socket_proxy:
    name: homelab_socket_proxy
    driver: bridge
    internal: true  # No external access - only container to container

# =============================================================================
# Reusable YAML Anchors
# =============================================================================

x-common-env: &common-env
  PUID: ${PUID:-1000}
  PGID: ${PGID:-100}
  TZ: ${TZ:-Europe/Rome}
  UMASK: 002

x-common-logging: &common-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "3"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s

# =============================================================================
# Infrastructure Services
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Docker Socket Proxy (Security Layer)
  # ---------------------------------------------------------------------------
  # Exposes limited Docker API to Traefik and Watchtower instead of raw socket
  # This prevents container escape attacks via unrestricted socket access
  # Docs: https://github.com/Tecnativa/docker-socket-proxy
  socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: socket-proxy
    privileged: true
    environment:
      # Granted permissions (read-only where possible)
      CONTAINERS: 1      # Traefik needs this for auto-discovery
      NETWORKS: 1        # Traefik needs this for network info
      SERVICES: 1        # Traefik needs this for swarm (optional)
      TASKS: 1           # Traefik needs this for swarm (optional)
      IMAGES: 1          # Watchtower needs this to check updates
      INFO: 1            # General Docker info
      VERSION: 1         # Docker version info
      # Watchtower needs POST for container operations
      POST: 1            # Required for Watchtower to restart containers
      # Explicitly denied (security)
      AUTH: 0
      SECRETS: 0
      BUILD: 0
      COMMIT: 0
      CONFIGS: 0
      DISTRIBUTION: 0
      EXEC: 0
      GRPC: 0
      NODES: 0
      PLUGINS: 0
      SESSION: 0
      SWARM: 0
      SYSTEM: 0
      VOLUMES: 0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - socket_proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:2375/version"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 16M

  # ---------------------------------------------------------------------------
  # DNS / Ad-blocking
  # ---------------------------------------------------------------------------
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    hostname: pihole
    env_file:
      - .env.secrets
    environment:
      TZ: ${TZ:-Europe/Rome}
      WEBPASSWORD: ${PIHOLE_PASSWORD:-changeme}
      FTLCONF_LOCAL_IPV4: ${NAS_IP:-192.168.3.10}
      PIHOLE_DNS_: 1.1.1.1;1.0.0.1
    volumes:
      - ./config/pihole/etc-pihole:/etc/pihole
      - ./config/pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8081:80"
    cap_add:
      - NET_ADMIN
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "dig", "+short", "+norecurse", "+retry=0", "@127.0.0.1", "pi.hole"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.pihole.rule=Host(`pihole.home.local`)"
      - "traefik.http.routers.pihole.entrypoints=websecure"
      - "traefik.http.routers.pihole.tls=true"
      - "traefik.http.routers.pihole.middlewares=authelia@docker"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"

  # ---------------------------------------------------------------------------
  # Container Management
  # ---------------------------------------------------------------------------
  # SECURITY NOTE: Portainer requires direct Docker socket access for full
  # functionality (exec, logs, console, volume management). Unlike Traefik and
  # Watchtower which only need read access, Portainer needs write operations.
  # The socket-proxy doesn't support Portainer's requirements (EXEC, VOLUMES, etc).
  # Risk mitigation: Portainer is only accessible via HTTPS with authentication.
  # If Portainer is compromised, attacker has full Docker control on this host.
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    command: -H unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/portainer:/data
    ports:
      - "9443:9443"
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "https://localhost:9443/api/system/status", "--no-check-certificate"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik (protected by Authelia with two_factor policy)
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`portainer.home.local`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.routers.portainer.middlewares=authelia@docker"
      - "traefik.http.services.portainer.loadbalancer.server.port=9443"
      - "traefik.http.services.portainer.loadbalancer.server.scheme=https"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    depends_on:
      - socket-proxy
    env_file:
      - .env.secrets
    environment:
      TZ: ${TZ:-Europe/Rome}
      DOCKER_HOST: tcp://socket-proxy:2375
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_LABEL_ENABLE: "true"
      WATCHTOWER_SCHEDULE: "0 30 7 * * *"
      WATCHTOWER_ROLLING_RESTART: "true"
      WATCHTOWER_TIMEOUT: 30s
      WATCHTOWER_HTTP_API_METRICS: "true"
      WATCHTOWER_HTTP_API_TOKEN: ${WATCHTOWER_API_TOKEN:-watchtower}
    ports:
      - "8383:8080"
    networks:
      - media_net
      - socket_proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/v1/metrics"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M

  # ---------------------------------------------------------------------------
  # Backup
  # ---------------------------------------------------------------------------
  # Duplicati: incremental backup with deduplication and encryption
  # WebUI: http://192.168.3.10:8200
  # Recommended configuration:
  #   - Daily backup /source/config -> /backups (local)
  #   - Daily backup -> Google Drive or Dropbox (offsite)
  #   - Retention: 7 daily, 4 weekly, 3 monthly
  duplicati:
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    environment:
      <<: *common-env
    volumes:
      - ./config/duplicati:/config
      - ./config:/source/config:ro        # Service configs (read-only)
      - /share/backup:/backups            # Local backup destination
    ports:
      - "8200:8200"
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.duplicati.rule=Host(`duplicati.home.local`)"
      - "traefik.http.routers.duplicati.entrypoints=websecure"
      - "traefik.http.routers.duplicati.tls=true"
      - "traefik.http.routers.duplicati.middlewares=authelia@docker"
      - "traefik.http.services.duplicati.loadbalancer.server.port=8200"

  # ---------------------------------------------------------------------------
  # Monitoring / Alerting
  # ---------------------------------------------------------------------------
  # Uptime Kuma: lightweight status monitoring with notifications
  # WebUI: http://192.168.3.10:3001 or https://uptime.home.local
  # Supports: HTTP, TCP, Ping, Docker, DNS, and more
  # Notifications: Home Assistant webhook, email (no Discord/Telegram)
  # Docs: https://github.com/louislam/uptime-kuma
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    volumes:
      - ./config/uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For Docker container monitoring
    ports:
      - "3001:3001"
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.uptime-kuma.rule=Host(`uptime.home.local`)"
      - "traefik.http.routers.uptime-kuma.entrypoints=websecure"
      - "traefik.http.routers.uptime-kuma.tls=true"
      - "traefik.http.routers.uptime-kuma.middlewares=authelia@docker"
      - "traefik.http.services.uptime-kuma.loadbalancer.server.port=3001"

  # ---------------------------------------------------------------------------
  # Authentication (SSO with Passkey/WebAuthn)
  # ---------------------------------------------------------------------------
  # Authelia: forward authentication for Traefik
  # Portal: https://auth.home.local
  # Docs: https://www.authelia.com/
  #
  # First time setup:
  #   1. Generate secrets: ./scripts/generate-authelia-secrets.sh
  #   2. Edit config/authelia/users_database.yml with your user
  #   3. Start stack: make up
  #   4. Access https://auth.home.local to register passkey
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    env_file:
      - .env.secrets
    environment:
      TZ: ${TZ:-Europe/Rome}
      AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE: /secrets/JWT_SECRET
      AUTHELIA_SESSION_SECRET_FILE: /secrets/SESSION_SECRET
      AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE: /secrets/STORAGE_ENCRYPTION_KEY
    volumes:
      - ./config/authelia:/config
      - ./secrets/authelia:/secrets:ro
    networks:
      - proxy
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "authelia", "healthcheck"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik - Authelia portal
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`auth.home.local`)"
      - "traefik.http.routers.authelia.entrypoints=websecure"
      - "traefik.http.routers.authelia.tls=true"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"
      # Forward Auth Middleware (used by other services)
      - "traefik.http.middlewares.authelia.forwardAuth.address=http://authelia:9091/api/authz/forward-auth"
      - "traefik.http.middlewares.authelia.forwardAuth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Email,Remote-Name"

  # ---------------------------------------------------------------------------
  # Reverse Proxy
  # ---------------------------------------------------------------------------
  # Traefik: reverse proxy with Docker auto-discovery
  # Dashboard: https://traefik.home.local (protected by Authelia)
  # Docs: https://doc.traefik.io/traefik/
  #
  # To expose a service, add these labels to the container:
  #   - "traefik.enable=true"
  #   - "traefik.http.routers.<name>.rule=Host(`<name>.home.local`)"
  #   - "traefik.http.routers.<name>.entrypoints=websecure"
  #   - "traefik.http.services.<name>.loadbalancer.server.port=<port>"
  #
  # Requires Pi-hole DNS records pointing *.home.local -> 192.168.3.10
  # See docs/setup/reverse-proxy-setup.md for full configuration guide
  traefik:
    image: traefik:v3.2
    container_name: traefik
    depends_on:
      - socket-proxy
    env_file:
      - .env.secrets
    command:
      # API and Dashboard (secured via middleware, not insecure mode)
      - --api.dashboard=true
      # Docker Provider (via socket proxy for security)
      - --providers.docker=true
      - --providers.docker.endpoint=tcp://socket-proxy:2375
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=homelab_proxy
      # File provider for non-Docker services (e.g., Home Assistant) and TLS config
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.websecure.address=:443
      # Logs
      - --log.level=INFO
      - --accesslog=true
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/traefik:/etc/traefik/dynamic
      - ./config/traefik/certs:/etc/traefik/certs:ro
    networks:
      - proxy
      - media_net
      - socket_proxy
    environment:
      <<: *common-env
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Dashboard on traefik.home.local (protected by Authelia with two_factor policy)
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.home.local`)"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls=true"
      - "traefik.http.routers.traefik-dashboard.middlewares=authelia@docker"
