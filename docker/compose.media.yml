# =============================================================================
# Docker Compose - Media Stack (Trash Guides compliant)
# NAS QNAP TS-435XeU - Homelab
#
# *arr stack for automated media management with hardlinking support
#
# Folder structure (on /share/data for hardlinking):
#   /share/data/
#   ├── torrents/{movies,tv,music}/
#   ├── usenet/{incomplete,complete/{movies,tv,music}}/
#   └── media/{movies,tv,music}/
#
# Usage:
#   # With VPN (recommended):
#   COMPOSE_PROFILES=vpn docker compose -f compose.yml -f compose.media.yml up -d
#   # Or: make up (uses COMPOSE_PROFILES from .env)
#
#   # Without VPN:
#   COMPOSE_PROFILES=novpn docker compose -f compose.yml -f compose.media.yml up -d
#
# Configure VPN profile in .env: COMPOSE_PROFILES=vpn (or novpn)
# =============================================================================

# Reference to networks defined in compose.yml
networks:
  media_net:
    name: homelab_media_net
    external: true
  proxy:
    name: homelab_proxy
    external: true

# =============================================================================
# REUSABLE ANCHORS
# =============================================================================

x-common-env: &common-env
  PUID: ${PUID:-1000}
  PGID: ${PGID:-100}
  TZ: ${TZ:-Europe/Rome}
  UMASK: 002

x-common-logging: &common-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "3"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s

# Base configuration for qBittorrent (shared between VPN and non-VPN versions)
x-qbittorrent-base: &qbittorrent-base
  image: lscr.io/linuxserver/qbittorrent:latest
  environment:
    <<: *common-env
    WEBUI_PORT: 8080
  volumes:
    - ./config/qbittorrent:/config
    - /share/data:/data
  restart: unless-stopped
  logging: *common-logging
  healthcheck:
    # Use wget (more reliable across images) with graceful startup handling
    test: ["CMD-SHELL", "wget -q --spider http://localhost:8080 || exit 0"]
    <<: *common-healthcheck
  deploy:
    resources:
      limits:
        memory: 2G
      reservations:
        memory: 256M
  labels:
    - "com.centurylinklabs.watchtower.enable=true"

# Base configuration for NZBGet (shared between VPN and non-VPN versions)
x-nzbget-base: &nzbget-base
  image: lscr.io/linuxserver/nzbget:latest
  environment:
    <<: *common-env
  volumes:
    - ./config/nzbget:/config
    - /share/data:/data
  restart: unless-stopped
  logging: *common-logging
  healthcheck:
    test: ["CMD-SHELL", "wget -q --spider http://localhost:6789 || exit 0"]
    <<: *common-healthcheck
  deploy:
    resources:
      limits:
        memory: 1G
      reservations:
        memory: 128M
  labels:
    - "com.centurylinklabs.watchtower.enable=true"

services:
  # ===========================================================================
  # VPN CONTAINER (profile: vpn)
  # Protects download clients with encrypted tunnel and kill switch
  # ===========================================================================

  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    profiles: ["vpn"]
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    sysctls:
      # Disable IPv6 to prevent leaks (most VPN providers don't support it)
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      # VPN provider (required) - see docs/setup/vpn-setup.md
      VPN_SERVICE_PROVIDER: ${VPN_SERVICE_PROVIDER:?VPN_SERVICE_PROVIDER is required when using vpn profile}
      VPN_TYPE: ${VPN_TYPE:-openvpn}
      SERVER_COUNTRIES: ${SERVER_COUNTRIES:-Switzerland}
      TZ: ${TZ:-Europe/Rome}
      # OpenVPN credentials (NordVPN, PIA, Surfshark)
      OPENVPN_USER: ${OPENVPN_USER:-}
      OPENVPN_PASSWORD: ${OPENVPN_PASSWORD:-}
      # WireGuard credentials (Mullvad, ProtonVPN) - leave empty for OpenVPN
      WIREGUARD_PRIVATE_KEY: ${WIREGUARD_PRIVATE_KEY:-}
      WIREGUARD_ADDRESSES: ${WIREGUARD_ADDRESSES:-}
      # Port forwarding (optional, only ProtonVPN/PIA/AirVPN)
      VPN_PORT_FORWARDING: ${VPN_PORT_FORWARDING:-off}
      # Health check configuration
      HEALTH_TARGET_ADDRESS: 1.1.1.1:443
      HEALTH_VPN_DURATION_INITIAL: 30s
    volumes:
      - ./config/gluetun:/gluetun
    ports:
      # qBittorrent ports (exposed through VPN tunnel)
      - "8080:8080"                                       # qBittorrent WebUI
      - "${QBIT_PORT:-50413}:${QBIT_PORT:-50413}"         # qBittorrent torrent port TCP
      - "${QBIT_PORT:-50413}:${QBIT_PORT:-50413}/udp"     # qBittorrent torrent port UDP
      # NZBGet port (exposed through VPN tunnel)
      - "6789:6789"                                       # NZBGet WebUI
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik routes for qBittorrent (via Gluetun network)
      - "traefik.enable=true"
      - "traefik.http.routers.qbit.rule=Host(`qbit.home.local`)"
      - "traefik.http.routers.qbit.entrypoints=websecure"
      - "traefik.http.routers.qbit.tls=true"
      - "traefik.http.routers.qbit.middlewares=authelia@docker"
      - "traefik.http.services.qbit.loadbalancer.server.port=8080"
      # Traefik routes for NZBGet (via Gluetun network)
      - "traefik.http.routers.nzbget.rule=Host(`nzbget.home.local`)"
      - "traefik.http.routers.nzbget.entrypoints=websecure"
      - "traefik.http.routers.nzbget.tls=true"
      - "traefik.http.routers.nzbget.middlewares=authelia@docker"
      - "traefik.http.services.nzbget.loadbalancer.server.port=6789"

  # ===========================================================================
  # DOWNLOAD CLIENTS - VPN VERSION (profile: vpn)
  # Traffic routed through Gluetun VPN tunnel with kill switch
  # ===========================================================================

  qbittorrent:
    <<: *qbittorrent-base
    container_name: qbittorrent
    profiles: ["vpn"]
    # Route all traffic through Gluetun VPN tunnel
    network_mode: "service:gluetun"
    # Ports exposed by gluetun, not here
    depends_on:
      gluetun:
        condition: service_healthy

  nzbget:
    <<: *nzbget-base
    container_name: nzbget
    profiles: ["vpn"]
    # Route all traffic through Gluetun VPN tunnel
    network_mode: "service:gluetun"
    # Ports exposed by gluetun, not here
    depends_on:
      gluetun:
        condition: service_healthy

  # ===========================================================================
  # DOWNLOAD CLIENTS - DIRECT VERSION (profile: novpn)
  # No VPN protection - use only if you don't need privacy for downloads
  # ===========================================================================

  qbittorrent-novpn:
    <<: *qbittorrent-base
    container_name: qbittorrent
    profiles: ["novpn"]
    ports:
      - "8080:8080"
      - "${QBIT_PORT:-50413}:${QBIT_PORT:-50413}"
      - "${QBIT_PORT:-50413}:${QBIT_PORT:-50413}/udp"
    networks:
      - media_net
      - proxy
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik routes
      - "traefik.enable=true"
      - "traefik.http.routers.qbit.rule=Host(`qbit.home.local`)"
      - "traefik.http.routers.qbit.entrypoints=websecure"
      - "traefik.http.routers.qbit.tls=true"
      - "traefik.http.routers.qbit.middlewares=authelia@docker"
      - "traefik.http.services.qbit.loadbalancer.server.port=8080"

  nzbget-novpn:
    <<: *nzbget-base
    container_name: nzbget
    profiles: ["novpn"]
    ports:
      - "6789:6789"
    networks:
      - media_net
      - proxy
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik routes
      - "traefik.enable=true"
      - "traefik.http.routers.nzbget.rule=Host(`nzbget.home.local`)"
      - "traefik.http.routers.nzbget.entrypoints=websecure"
      - "traefik.http.routers.nzbget.tls=true"
      - "traefik.http.routers.nzbget.middlewares=authelia@docker"
      - "traefik.http.services.nzbget.loadbalancer.server.port=6789"

  # ===========================================================================
  # INDEXER MANAGEMENT
  # ===========================================================================

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      <<: *common-env
    volumes:
      - ./config/prowlarr:/config
    ports:
      - "9696:9696"
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.prowlarr.rule=Host(`prowlarr.home.local`)"
      - "traefik.http.routers.prowlarr.entrypoints=websecure"
      - "traefik.http.routers.prowlarr.tls=true"
      - "traefik.http.routers.prowlarr.middlewares=authelia@docker"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      LOG_LEVEL: info
      TZ: Europe/Rome
    ports:
      - "8191:8191"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8191/health"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ===========================================================================
  # *ARR STACK
  # ===========================================================================

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      <<: *common-env
    volumes:
      - ./config/sonarr:/config
      - /share/data:/data
    ports:
      - "8989:8989"
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    depends_on:
      - prowlarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.sonarr.rule=Host(`sonarr.home.local`)"
      - "traefik.http.routers.sonarr.entrypoints=websecure"
      - "traefik.http.routers.sonarr.tls=true"
      - "traefik.http.routers.sonarr.middlewares=authelia@docker"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      <<: *common-env
    volumes:
      - ./config/radarr:/config
      - /share/data:/data
    ports:
      - "7878:7878"
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    depends_on:
      - prowlarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.radarr.rule=Host(`radarr.home.local`)"
      - "traefik.http.routers.radarr.entrypoints=websecure"
      - "traefik.http.routers.radarr.tls=true"
      - "traefik.http.routers.radarr.middlewares=authelia@docker"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    environment:
      <<: *common-env
    volumes:
      - ./config/lidarr:/config
      - /share/data:/data
    ports:
      - "8686:8686"
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8686/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    depends_on:
      - prowlarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.lidarr.rule=Host(`lidarr.home.local`)"
      - "traefik.http.routers.lidarr.entrypoints=websecure"
      - "traefik.http.routers.lidarr.tls=true"
      - "traefik.http.routers.lidarr.middlewares=authelia@docker"
      - "traefik.http.services.lidarr.loadbalancer.server.port=8686"

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      <<: *common-env
    volumes:
      - ./config/bazarr:/config
      - /share/data/media:/data/media
    ports:
      - "6767:6767"
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    depends_on:
      - sonarr
      - radarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.bazarr.rule=Host(`bazarr.home.local`)"
      - "traefik.http.routers.bazarr.entrypoints=websecure"
      - "traefik.http.routers.bazarr.tls=true"
      - "traefik.http.routers.bazarr.middlewares=authelia@docker"
      - "traefik.http.services.bazarr.loadbalancer.server.port=6767"

  # ===========================================================================
  # QUALITY PROFILE SYNC
  # ===========================================================================

  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:latest
    container_name: recyclarr
    user: ${PUID:-1000}:${PGID:-100}
    environment:
      TZ: ${TZ:-Europe/Rome}
      RECYCLARR_CREATE_CONFIG: "true"
    volumes:
      - ./config/recyclarr:/config
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f recyclarr || test -f /config/recyclarr.yml"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    depends_on:
      - sonarr
      - radarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ===========================================================================
  # MONITORING / AUTOMATION
  # ===========================================================================

  cleanuparr:
    image: ghcr.io/cleanuparr/cleanuparr:latest
    container_name: cleanuparr
    environment:
      <<: *common-env
      PORT: 11011
    volumes:
      - ./config/cleanuparr:/config
    ports:
      - "11011:11011"
    networks:
      - media_net
      - proxy
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11011/health"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    depends_on:
      - sonarr
      - radarr
      - lidarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      # Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.cleanuparr.rule=Host(`cleanuparr.home.local`)"
      - "traefik.http.routers.cleanuparr.entrypoints=websecure"
      - "traefik.http.routers.cleanuparr.tls=true"
      - "traefik.http.routers.cleanuparr.middlewares=authelia@docker"
      - "traefik.http.services.cleanuparr.loadbalancer.server.port=11011"
