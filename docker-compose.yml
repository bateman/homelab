# Docker Compose - Media Stack (Trash Guides compliant)
# NAS QNAP TS-435XeU - Homelab
#
# Struttura cartelle raccomandata (da creare sul NAS):
#
#   /share/data/                    <- Mount point unico per hardlinking
#   ├── torrents/
#   │   ├── movies/
#   │   ├── tv/
#   │   └── music/
#   ├── usenet/
#   │   ├── incomplete/
#   │   └── complete/
#   │       ├── movies/
#   │       ├── tv/
#   │       └── music/
#   └── media/
#       ├── movies/
#       ├── tv/
#       └── music/
#
# Hardlinking funziona solo se downloads e media sono sullo stesso filesystem!
#
# IP di riferimento (VLAN 3 - Servers):
#   NAS QNAP:     192.168.3.10
#   Mini PC:      192.168.3.20
#   Stampante:    192.168.3.30
#   PC Desktop:   192.168.3.40

networks:
  media_net:
    driver: bridge

x-common-env: &common-env
  PUID: 1000
  PGID: 100
  TZ: Europe/Rome
  UMASK: 002

x-common-logging: &common-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "3"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s

services:
  # ============================================================================
  # DOWNLOAD CLIENTS
  # ============================================================================

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment:
      <<: *common-env
      WEBUI_PORT: 8080
    volumes:
      - ./config/qbittorrent:/config
      - /share/data:/data              # Full /data mount per path consistency
    ports:
      - "50413:50413"                   # Porta torrent (evita 6881 default)
      - "50413:50413/udp"
      - "8080:8080"                     # WebUI
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 256M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  nzbget:
    image: lscr.io/linuxserver/nzbget:latest
    container_name: nzbget
    environment:
      <<: *common-env
    volumes:
      - ./config/nzbget:/config
      - /share/data:/data              # Full /data mount per path consistency
    ports:
      - "6789:6789"                     # WebUI
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6789"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 128M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ============================================================================
  # INDEXER MANAGER
  # ============================================================================

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    environment:
      <<: *common-env
    volumes:
      - ./config/prowlarr:/config
    ports:
      - "9696:9696"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    environment:
      LOG_LEVEL: info
      TZ: Europe/Rome
    ports:
      - "8191:8191"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8191/health"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ============================================================================
  # *ARR STACK
  # ============================================================================

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment:
      <<: *common-env
    volumes:
      - ./config/sonarr:/config
      - /share/data:/data               # Accesso a tutto /data per hardlinking
    ports:
      - "8989:8989"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    depends_on:
      - qbittorrent
      - nzbget
      - prowlarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment:
      <<: *common-env
    volumes:
      - ./config/radarr:/config
      - /share/data:/data               # Accesso a tutto /data per hardlinking
    ports:
      - "7878:7878"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    depends_on:
      - qbittorrent
      - nzbget
      - prowlarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    environment:
      <<: *common-env
    volumes:
      - ./config/lidarr:/config
      - /share/data:/data               # Accesso a tutto /data per hardlinking
    ports:
      - "8686:8686"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8686/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    depends_on:
      - qbittorrent
      - nzbget
      - prowlarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      <<: *common-env
    volumes:
      - ./config/bazarr:/config
      - /share/data/media:/data/media   # Solo media, non serve downloads
    ports:
      - "6767:6767"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767/ping"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    depends_on:
      - sonarr
      - radarr
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ============================================================================
  # MONITORING / AUTOMATION
  # ============================================================================

  huntarr:
    image: ghcr.io/jordanpottruff/huntarr:latest
    container_name: huntarr
    environment:
      TZ: Europe/Rome
    volumes:
      - ./config/huntarr:/config
    ports:
      - "7500:7500"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7500"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  cleanuparr:
    image: ghcr.io/cleanuparr/cleanuparr:latest
    container_name: cleanuparr
    environment:
      <<: *common-env
      PORT: 11011
    volumes:
      - ./config/cleanuparr:/config
    ports:
      - "11011:11011"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11011/health"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    depends_on:
      - sonarr
      - radarr
      - lidarr
      - qbittorrent
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ============================================================================
  # NETWORK / DNS
  # ============================================================================

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    hostname: pihole
    environment:
      TZ: Europe/Rome
      WEBPASSWORD: ${PIHOLE_PASSWORD:-changeme}   # Usa .env file
      FTLCONF_LOCAL_IPV4: 192.168.3.10            # IP del NAS (VLAN 3 - Servers)
      PIHOLE_DNS_: 1.1.1.1;1.0.0.1                # Cloudflare upstream
    volumes:
      - ./config/pihole/etc-pihole:/etc/pihole
      - ./config/pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8081:80"
    cap_add:
      - NET_ADMIN
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "dig", "+short", "+norecurse", "+retry=0", "@127.0.0.1", "pi.hole"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ============================================================================
  # HOME AUTOMATION
  # ============================================================================

  # NOTA: Home Assistant usa network_mode: host per il discovery di dispositivi
  # (Zigbee, Bluetooth, mDNS). Questo significa che:
  # - Non fa parte della rete media_net
  # - Non puo' risolvere altri container per nome
  # - Comunica con altri servizi tramite IP host (192.168.3.10)
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    environment:
      TZ: Europe/Rome
    volumes:
      - ./config/homeassistant:/config
      - /run/dbus:/run/dbus:ro          # Per Bluetooth (se necessario)
    network_mode: host                   # Necessario per discovery dispositivi
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/api/"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ============================================================================
  # MANAGEMENT
  # ============================================================================

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    command: -H unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/portainer:/data
    ports:
      - "9443:9443"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "https://localhost:9443/api/system/status", "--no-check-certificate"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    environment:
      TZ: Europe/Rome
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_LABEL_ENABLE: "true"
      WATCHTOWER_SCHEDULE: "0 0 4 * * *"    # Ogni giorno alle 04:00
      WATCHTOWER_ROLLING_RESTART: "true"
      WATCHTOWER_TIMEOUT: 30s
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "pgrep", "-f", "watchtower"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M
