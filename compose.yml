# =============================================================================
# Docker Compose - Infrastructure Stack
# NAS QNAP TS-435XeU - Homelab
#
# Servizi infrastrutturali: DNS, automazione, gestione container
# Per lo stack media, vedi compose.media.yml
#
# Uso:
#   docker compose -f compose.yml -f compose.media.yml up -d
#   oppure: make up
# =============================================================================

# Network condivisa tra tutti i servizi
networks:
  media_net:
    driver: bridge

# =============================================================================
# Anchor YAML riutilizzabili
# =============================================================================

x-common-env: &common-env
  PUID: 1000
  PGID: 100
  TZ: Europe/Rome
  UMASK: 002

x-common-logging: &common-logging
  driver: json-file
  options:
    max-size: "50m"
    max-file: "3"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 60s

# =============================================================================
# Servizi Infrastruttura
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # DNS / Ad-blocking
  # ---------------------------------------------------------------------------
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    hostname: pihole
    environment:
      TZ: Europe/Rome
      WEBPASSWORD: ${PIHOLE_PASSWORD:-changeme}
      FTLCONF_LOCAL_IPV4: 192.168.3.10
      PIHOLE_DNS_: 1.1.1.1;1.0.0.1
    volumes:
      - ./config/pihole/etc-pihole:/etc/pihole
      - ./config/pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8081:80"
    cap_add:
      - NET_ADMIN
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "dig", "+short", "+norecurse", "+retry=0", "@127.0.0.1", "pi.hole"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ---------------------------------------------------------------------------
  # Home Automation
  # ---------------------------------------------------------------------------
  # NOTA: Home Assistant usa network_mode: host per il discovery di dispositivi
  # (Zigbee, Bluetooth, mDNS). Questo significa che:
  # - Non fa parte della rete media_net
  # - Non puo' risolvere altri container per nome
  # - Comunica con altri servizi tramite IP host (192.168.3.10)
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    environment:
      TZ: Europe/Rome
    volumes:
      - ./config/homeassistant:/config
      - /run/dbus:/run/dbus:ro
    network_mode: host
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/api/"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ---------------------------------------------------------------------------
  # Container Management
  # ---------------------------------------------------------------------------
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    command: -H unix:///var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/portainer:/data
    ports:
      - "9443:9443"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "https://localhost:9443/api/system/status", "--no-check-certificate"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    environment:
      TZ: Europe/Rome
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_LABEL_ENABLE: "true"
      WATCHTOWER_SCHEDULE: "0 0 4 * * *"
      WATCHTOWER_ROLLING_RESTART: "true"
      WATCHTOWER_TIMEOUT: 30s
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "pgrep", "-f", "watchtower"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M

  # ---------------------------------------------------------------------------
  # Backup
  # ---------------------------------------------------------------------------
  # Duplicati: backup incrementale con deduplica e cifratura
  # WebUI: http://192.168.3.10:8200
  # Configurazione consigliata:
  #   - Backup giornaliero /source/config -> /backups (locale)
  #   - Backup settimanale -> Backblaze B2 (offsite)
  #   - Retention: 7 daily, 4 weekly, 3 monthly
  duplicati:
    image: lscr.io/linuxserver/duplicati:latest
    container_name: duplicati
    environment:
      <<: *common-env
    volumes:
      - ./config/duplicati:/config
      - ./config:/source/config:ro        # Config servizi (read-only)
      - /share/backup:/backups            # Destinazione backup locale
    ports:
      - "8200:8200"
    networks:
      - media_net
    restart: unless-stopped
    logging: *common-logging
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8200"]
      <<: *common-healthcheck
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
